CREATE TABLE xp_item_definitions (
  id INT PRIMARY KEY,
  nome TEXT NOT NULL,
  xp INT NOT NULL,
);

CREATE TABLE public.skills (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  image TEXT, 
  descricao TEXT,
  xp_skill INT NOT NULL,
  base_effect JSONB NOT NULL
);

-- 1. ATUALIZAR TABELA SKILLS
ALTER TABLE public.skills 
  DROP COLUMN IF EXISTS base_effect,
  ADD COLUMN tipo TEXT NOT NULL DEFAULT 'dano', -- dano, buff, debuff, dot, especial
  ADD COLUMN duracao INT DEFAULT 1, -- turnos de duração do efeito
  ADD COLUMN cooldown INT DEFAULT 0, -- turnos de recarga
  ADD COLUMN alvo TEXT DEFAULT 'inimigo', -- inimigo, self, ambos
  ADD COLUMN efeito JSONB NOT NULL DEFAULT '{}'; -- estrutura flexível para efeitos

-- Index para queries por tipo
CREATE INDEX idx_skills_tipo ON public.skills(tipo);

-- 2. ATUALIZAR USER_SKILLS
ALTER TABLE public.user_skills
  DROP COLUMN equipada,
  DROP COLUMN quantidade,
  ADD COLUMN slot SMALLINT CHECK (slot BETWEEN 1 AND 6), -- slot equipado (null = não equipado)
  ADD COLUMN nivel_desbloqueio INT NOT NULL DEFAULT 10; -- quando pode equipar

-- Constraint: 1 skill por slot
CREATE UNIQUE INDEX idx_user_skills_slot ON public.user_skills(user_id, slot) WHERE slot IS NOT NULL;

-- Index otimizado para buscar skills equipadas
CREATE INDEX idx_user_skills_equipadas ON public.user_skills(user_id) WHERE slot IS NOT NULL;

-- 3. NOVA TABELA: BATALHAS
CREATE TABLE public.batalhas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  oponente_id UUID REFERENCES public.users(id) ON DELETE SET NULL, -- null = NPC
  turno_atual INT NOT NULL DEFAULT 1,
  status TEXT NOT NULL DEFAULT 'ativa', -- ativa, finalizada
  vencedor_id UUID,
  estado JSONB NOT NULL, -- HP, buffs, debuffs, cooldowns
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_batalhas_user ON public.batalhas(user_id) WHERE status = 'ativa';

-- 4. TABELA DE EFEITOS ATIVOS (durante batalha)
CREATE TABLE public.batalha_efeitos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  batalha_id UUID NOT NULL REFERENCES public.batalhas(id) ON DELETE CASCADE,
  alvo TEXT NOT NULL, -- 'user', 'oponente'
  tipo TEXT NOT NULL,
  valor NUMERIC,
  turnos_restantes INT NOT NULL,
  metadata JSONB DEFAULT '{}'
);

CREATE INDEX idx_batalha_efeitos_lookup ON public.batalha_efeitos(batalha_id, alvo);


insert into skills
(id, name, image, descricao, tipo, duracao, cooldown, alvo, efeito)
values
(1,'Chuva Astral','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/chuva-astral.png','Invoca uma chuva que dura 3 turnos, causando 70% de dano por turno.','dot',1,7,'inimigo','{"dano":70}'),
(2,'Escudo Arcano','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/escudo-arcano.png','3 Esferas arcana giram ao seu redor, reduzindo todo dano recebido em 10%','buff',1,6,'self','{"armor":10}'),
(3,'Cura Vitalizadora','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/pocao-vitalizadora.png','Recupera 10% de vida e +50% dano no próximo ataque.','buff',1,8,'self','{"cura":10}'),
(4,'Torrente Perfurante','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/torrente-perfurante.png','Ignora qualquer defesa do oponente e causa 150% de dano.','dano',1,5,'inimigo','{"dano":150,"ignora_defesa":true}'),
(5,'Esquiva Fantasma','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/esquiva-fantasma.png','Bloqueia toda fonte de dano no próximo turno.','buff',1,7,'self','{"block":true}'),
(6,'Julgamento Celestial','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/julgamento-celestial.png','Invoca uma torrente de magia dos céus que causa 300% de dano.','dano',1,10,'inimigo','{"dano":300}'),
(7,'Espelho Mágico','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/espelho-magico.png','Reflete 50% de dano do próximo ataque direto.','buff',1,4,'self','{"reflect":50}'),
(8,'Levitação','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/levitacao.png','Inimigo impossibilitado de jogar por um turno.','debuff',1,6,'inimigo','{"atordoamento":true}'),
(9,'Espectro Infernal','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/espectro-infernal.png','Invoca um espectro que ataca o oponente todo turno. 25% de dano.','dot',99,99,'inimigo','{"dano":40}'),
(10,'Aero Impacto','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/aero-impacto.png','Casta dois golpes de ar, causando 200% de dano.','dano',1,6,'inimigo','{"dano":200}'),
(11,'Foco','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/foco.png','Canaliza energia para causar 15% de dano a mais todo turno.','buff',99,99,'self','{"buff_permanente":{"ataque":15}}'),
(12,'Golpe Sagaz','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/golpe-sagaz.png','Magia curva, atinge as costas do oponente com 200% de dano','dano',1,7,'inimigo','{"dano":200,"ignora_defesa":true}'),
(13,'Chuva Meteórica','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/chuva-meteorica.png','Chuva de meteoros que causa 25% de dano todo turno.','dot',99,99,'inimigo','{"dano":40}'),
(14,'Impacto Amaldiçoado','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/impacto-amaldicoado.png','Causa 150% do dano e reduz 10% do ataque inimigo.','dano',1,5,'inimigo','{"dano":150,"debuff_ataque":{"ataque":-10}}'),
(15,'Execução','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/execucao.png','Causa 150% de dano, 250% se vida do alvo for menor que 30%.','dano',1,5,'inimigo','{"dano":150,"condicional":{"dano_extra":150,"vida_abaixo":30}}'),
(16,'Maldição Necro','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/maldicao-necro.png','Invocação necromante que causa 25% de dano todo turno.','dot',99,99,'inimigo','{"dano":40}'),
(17,'Projeção Maldita','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/projecao-maldita.png','Projeta um espírito que faz o oponente tomar 10% de dano a mais até o fim da partida.','debuff',1,5,'inimigo','{"armor_reduction":10}'),
(18,'Insanidade Explosiva','https://fjgunsokakbcycuiwllg.supabase.co/storage/v1/object/public/skills/insanidade-explosiva.png','Causa 300% de dano mas aumenta permanentemente todo dano recebido em 10%.','dano',1,6,'inimigo','{"dano":300,"armor_reduction":10}');
